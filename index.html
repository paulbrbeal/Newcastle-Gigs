<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Newcastle Gigs</title>
<style>
  :root {
    --bg:#0f1117;--surface:#1a1d27;--card:#22263a;--accent:#7c6af7;
    --accent2:#f7a26a;--text:#e8eaf0;--muted:#8890a8;--border:#2e3248;
    --danger:#e05c6e;--success:#4caf82;--radius:10px;--font:'Segoe UI',system-ui,sans-serif;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh}
  /* NAV */
  nav{background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:0;padding:0 1rem;position:sticky;top:0;z-index:50}
  .brand{font-weight:700;font-size:1.1rem;color:var(--accent);padding:1rem .5rem 1rem 0;margin-right:1rem;white-space:nowrap}
  .tab{background:none;border:none;color:var(--muted);padding:.9rem 1.1rem;cursor:pointer;font-size:.95rem;border-bottom:2px solid transparent;transition:.2s;font-family:var(--font)}
  .tab:hover{color:var(--text)}
  .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
  /* MAIN */
  main{max-width:1100px;margin:0 auto;padding:1.5rem 1rem}
  .page{display:none}.page.active{display:block}
  /* CARDS */
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;margin-bottom:1.25rem}
  h2{font-size:1.25rem;font-weight:700;margin-bottom:1.25rem;color:var(--text)}
  /* FORM */
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
  @media(max-width:600px){.form-grid{grid-template-columns:1fr}}
  .field{display:flex;flex-direction:column;gap:.4rem}
  .field label{font-size:.85rem;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.04em}
  .field input,.field textarea{background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:.55rem .75rem;font-size:.95rem;font-family:var(--font);transition:.2s;width:100%}
  .field input:focus,.field textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(124,106,247,.2)}
  .field textarea{resize:vertical;min-height:72px}
  .field input[type=date]::-webkit-calendar-picker-indicator{filter:invert(1) opacity(.5)}
  .full{grid-column:1/-1}
  /* BUTTONS */
  .btn{display:inline-flex;align-items:center;gap:.4rem;padding:.55rem 1.1rem;border-radius:6px;border:none;cursor:pointer;font-size:.9rem;font-weight:600;font-family:var(--font);transition:.2s}
  .btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{background:#6857e0}
  .btn-secondary{background:var(--surface);color:var(--text);border:1px solid var(--border)}.btn-secondary:hover{border-color:var(--accent);color:var(--accent)}
  .btn-danger{background:transparent;color:var(--danger);border:1px solid var(--danger)}.btn-danger:hover{background:var(--danger);color:#fff}
  .btn-sm{padding:.35rem .75rem;font-size:.82rem}
  /* ALERTS */
  .alert{padding:.75rem 1rem;border-radius:6px;font-size:.9rem;margin-bottom:1rem}
  .alert-success{background:rgba(76,175,130,.15);border:1px solid var(--success);color:var(--success)}
  .alert-warn{background:rgba(247,162,106,.15);border:1px solid var(--accent2);color:var(--accent2)}
  .alert-err{background:rgba(224,92,110,.15);border:1px solid var(--danger);color:var(--danger)}
  /* CONTROLS BAR */
  .controls{display:flex;gap:.75rem;flex-wrap:wrap;align-items:center;margin-bottom:1rem}
  .controls input{background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:.45rem .75rem;font-size:.9rem;font-family:var(--font)}
  .controls input:focus{outline:none;border-color:var(--accent)}
  /* TABLE */
  .table-wrap{overflow-x:auto}
  table{width:100%;border-collapse:collapse;font-size:.9rem}
  th{text-align:left;padding:.6rem .75rem;color:var(--muted);font-size:.8rem;text-transform:uppercase;letter-spacing:.05em;border-bottom:1px solid var(--border);white-space:nowrap}
  td{padding:.65rem .75rem;border-bottom:1px solid var(--border);vertical-align:top}
  tr:last-child td{border-bottom:none}
  tr:hover td{background:rgba(255,255,255,.02)}
  .cost-badge{display:inline-block;padding:.2rem .55rem;border-radius:20px;font-size:.8rem;font-weight:700;background:rgba(76,175,130,.15);color:var(--success)}
  .cost-badge.paid{background:rgba(247,162,106,.12);color:var(--accent2)}
  .link-out{color:var(--accent);font-size:.82rem;text-decoration:none}.link-out:hover{text-decoration:underline}
  .note-cell{color:var(--muted);font-size:.82rem;max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .action-btns{display:flex;gap:.4rem}
  .empty-state{text-align:center;padding:3rem;color:var(--muted)}
  /* MONTH NAV */
  .month-nav{display:flex;align-items:center;gap:.75rem;margin-bottom:1rem}
  .month-nav h3{flex:1;text-align:center;font-size:1.1rem}
  /* CALENDAR */
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
  .cal-header{text-align:center;font-size:.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;padding:.4rem 0}
  .cal-day{background:var(--card);border:1px solid var(--border);border-radius:6px;min-height:90px;padding:.5rem;position:relative;cursor:default}
  .cal-day.other-month{opacity:.35}
  .cal-day.today{border-color:var(--accent)}
  .cal-day-num{font-size:.78rem;font-weight:700;color:var(--muted);margin-bottom:.3rem;display:flex;justify-content:space-between;align-items:center}
  .cal-day-num .badge{background:var(--accent);color:#fff;border-radius:20px;font-size:.65rem;padding:.05rem .4rem}
  .cal-gig{background:rgba(124,106,247,.18);border-left:2px solid var(--accent);border-radius:3px;padding:.2rem .35rem;font-size:.72rem;margin-bottom:.25rem;cursor:pointer;line-height:1.3;transition:.15s}
  .cal-gig:hover{background:rgba(124,106,247,.35)}
  @media(max-width:700px){.cal-day{min-height:60px;padding:.3rem}.cal-gig{display:none}.cal-day.has-gigs .cal-day-num .badge{display:inline}}
  /* MODAL */
  .modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center;padding:1rem}
  .modal-bg.open{display:flex}
  .modal{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:1.75rem;max-width:480px;width:100%;position:relative;max-height:90vh;overflow-y:auto}
  .modal-close{position:absolute;top:.75rem;right:.75rem;background:none;border:none;color:var(--muted);font-size:1.4rem;cursor:pointer;line-height:1}
  .modal-close:hover{color:var(--text)}
  .detail-row{display:flex;gap:.5rem;margin-bottom:.6rem;font-size:.93rem}
  .detail-label{color:var(--muted);min-width:80px;font-size:.8rem;font-weight:700;text-transform:uppercase;padding-top:.1rem}
  /* IMPORT/EXPORT */
  .import-area{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
  #importFile{display:none}
</style>
</head>
<body>

<nav>
  <div class="brand">ðŸŽ¸ NCL Gigs</div>
  <button class="tab active" onclick="showPage('add')" id="tab-add">Add a Gig</button>
  <button class="tab" onclick="showPage('list')" id="tab-list">Gig List</button>
  <button class="tab" onclick="showPage('calendar')" id="tab-calendar">Calendar</button>
</nav>

<main>

  <!-- ===== ADD GIG PAGE ===== -->

  <div class="page active" id="page-add">
    <div class="card">
      <h2>Add a Gig</h2>
      <div id="add-msg"></div>
      <form id="addForm" novalidate>
        <div class="form-grid">
          <div class="field">
            <label for="f-artist">Artist / Act *</label>
            <input type="text" id="f-artist" placeholder="e.g. The Unthanks" required/>
          </div>
          <div class="field">
            <label for="f-date">Date *</label>
            <input type="date" id="f-date" required/>
          </div>
          <div class="field">
            <label for="f-venue">Venue *</label>
            <input type="text" id="f-venue" placeholder="e.g. Sage Gateshead" required/>
          </div>
          <div class="field">
            <label for="f-cost">Cost (Â£) *</label>
            <input type="number" id="f-cost" placeholder="0" min="0" step="0.01" required/>
          </div>
          <div class="field">
            <label for="f-link">Ticket / Event Link</label>
            <input type="url" id="f-link" placeholder="https://..."/>
          </div>
          <div class="field">
            <label for="f-submittedBy">Your Name (optional)</label>
            <input type="text" id="f-submittedBy" placeholder="Anonymous"/>
          </div>
          <div class="field full">
            <label for="f-notes">Notes</label>
            <textarea id="f-notes" placeholder="Doors, support acts, age restrictionsâ€¦"></textarea>
          </div>
        </div>
        <div style="margin-top:1.25rem;display:flex;gap:.75rem;flex-wrap:wrap">
          <button type="submit" class="btn btn-primary">ï¼‹ Add Gig</button>
          <button type="button" class="btn btn-secondary" onclick="resetForm()">Clear</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== GIG LIST PAGE ===== -->

  <div class="page" id="page-list">
    <div class="card">
      <h2>Gig List</h2>
      <div class="controls">
        <input type="search" id="searchBox" placeholder="ðŸ” Search artist or venueâ€¦" oninput="renderList()" style="flex:1;min-width:160px"/>
        <button class="btn btn-secondary btn-sm" onclick="prevMonth('list')">â€¹ Prev</button>
        <span id="listMonthLabel" style="font-size:.9rem;white-space:nowrap"></span>
        <button class="btn btn-secondary btn-sm" onclick="nextMonth('list')">Next â€º</button>
        <button class="btn btn-secondary btn-sm" onclick="clearMonthFilter()">All Dates</button>
        <button class="btn btn-secondary btn-sm" onclick="toggleSort()">Sort: <span id="sortLabel">Date â†‘</span></button>
      </div>
      <div class="controls" style="margin-bottom:1.25rem">
        <button class="btn btn-secondary btn-sm" onclick="exportCSV()">â¬‡ Export CSV</button>
        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('importFile').click()">â¬† Import CSV</button>
        <input type="file" id="importFile" accept=".csv,text/csv" onchange="importCSV(this)"/>
      </div>
      <div id="import-msg"></div>
      <div class="table-wrap">
        <table id="gigTable">
          <thead>
            <tr>
              <th>Date</th><th>Artist</th><th>Venue</th><th>Cost</th>
              <th>Link</th><th>Notes</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="gigTableBody"></tbody>
        </table>
        <div id="listEmpty" class="empty-state" style="display:none">No gigs found. Add one!</div>
      </div>
    </div>
  </div>

  <!-- ===== CALENDAR PAGE ===== -->

  <div class="page" id="page-calendar">
    <div class="card">
      <div class="month-nav">
        <button class="btn btn-secondary btn-sm" onclick="prevMonth('cal')">â€¹</button>
        <h3 id="calMonthLabel"></h3>
        <button class="btn btn-secondary btn-sm" onclick="nextMonth('cal')">â€º</button>
        <button class="btn btn-secondary btn-sm" onclick="jumpToday()">Today</button>
      </div>
      <div class="cal-grid" id="calGrid"></div>
    </div>
  </div>

</main>

<!-- MODAL -->

<div class="modal-bg" id="modalBg" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()" aria-label="Close">Ã—</button>
    <h2 id="modalTitle" style="margin-bottom:1rem"></h2>
    <div id="modalBody"></div>
    <div style="margin-top:1.25rem;display:flex;gap:.75rem">
      <button class="btn btn-secondary btn-sm" id="modalEditBtn">Edit</button>
      <button class="btn btn-danger btn-sm" id="modalDeleteBtn">Delete</button>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->

<div class="modal-bg" id="editModalBg" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
  <div class="modal">
    <button class="modal-close" onclick="closeEditModal()" aria-label="Close">Ã—</button>
    <h2 id="editModalTitle" style="margin-bottom:1rem">Edit Gig</h2>
    <div id="edit-msg"></div>
    <form id="editForm" novalidate>
      <input type="hidden" id="e-id"/>
      <div class="form-grid">
        <div class="field"><label for="e-artist">Artist *</label><input type="text" id="e-artist" required/></div>
        <div class="field"><label for="e-date">Date *</label><input type="date" id="e-date" required/></div>
        <div class="field"><label for="e-venue">Venue *</label><input type="text" id="e-venue" required/></div>
        <div class="field"><label for="e-cost">Cost (Â£) *</label><input type="number" id="e-cost" min="0" step="0.01" required/></div>
        <div class="field"><label for="e-link">Link</label><input type="url" id="e-link"/></div>
        <div class="field"><label for="e-submittedBy">Your Name</label><input type="text" id="e-submittedBy"/></div>
        <div class="field full"><label for="e-notes">Notes</label><textarea id="e-notes"></textarea></div>
      </div>
      <div style="margin-top:1.25rem;display:flex;gap:.75rem">
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ===================================================
   STORAGE HELPERS
   All data lives in localStorage under this key.
=================================================== */
const STORE_KEY = 'newcastle_gigs_v1';

// Read gigs array from localStorage; return [] if missing/corrupt
function loadGigs() {
  try { return JSON.parse(localStorage.getItem(STORE_KEY)) || []; }
  catch { return []; }
}

// Write gigs array back to localStorage, sorted by date ascending
function saveGigs(arr) {
  const sorted = [...arr].sort((a,b) => a.date.localeCompare(b.date));
  localStorage.setItem(STORE_KEY, JSON.stringify(sorted));
  return sorted;
}

/* ===================================================
   ID / DATE UTILITIES
=================================================== */
// Generate a simple unique ID
const uid = () => Math.random().toString(36).slice(2,10) + Date.now().toString(36);

// Format ISO date (yyyy-mm-dd) as friendly "Sat 12 Jul 2025"
function friendlyDate(iso) {
  // Parse as local date to avoid timezone shifts
  const [y,m,d] = iso.split('-').map(Number);
  return new Date(y,m-1,d).toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short',year:'numeric'});
}

// Format cost: Â£0 â†’ "Free", else "Â£12.50"
function formatCost(n) {
  return n === 0 ? 'Free' : 'Â£' + Number(n).toFixed(2).replace(/\.00$/,'');
}

/* ===================================================
   PAGE NAVIGATION
=================================================== */
let currentPage = 'add';
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  document.getElementById('tab-'+id).classList.add('active');
  currentPage = id;
  if (id === 'list') renderList();
  if (id === 'calendar') renderCalendar();
}

/* ===================================================
   ADD GIG FORM
=================================================== */
document.getElementById('addForm').addEventListener('submit', function(e) {
  e.preventDefault();
  clearMsg('add-msg');

  // Gather + validate
  const artist = v('f-artist').trim();
  const date   = v('f-date').trim();
  const venue  = v('f-venue').trim();
  const costRaw = v('f-cost');
  const link   = v('f-link').trim();
  const notes  = v('f-notes').trim();
  const submittedBy = v('f-submittedBy').trim();

  if (!artist || !date || !venue || costRaw === '') {
    return showMsg('add-msg', 'Please fill in all required fields.', 'err');
  }
  if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {
    return showMsg('add-msg', 'Invalid date.', 'err');
  }
  const cost = parseFloat(costRaw);
  if (isNaN(cost) || cost < 0) {
    return showMsg('add-msg', 'Cost must be 0 or more.', 'err');
  }

  // Duplicate check: same artist + date + venue (case-insensitive)
  const gigs = loadGigs();
  const dup = gigs.find(g =>
    g.artist.toLowerCase() === artist.toLowerCase() &&
    g.date === date &&
    g.venue.toLowerCase() === venue.toLowerCase()
  );
  if (dup && !this.dataset.override) {
    this.dataset.override = '1';
    return showMsg('add-msg', 'âš ï¸ A gig with this artist, date, and venue already exists. Submit again to add anyway.', 'warn');
  }
  delete this.dataset.override;

  // Build record
  const gig = { id: uid(), artist, date, venue, cost, link, notes, submittedBy, createdAt: new Date().toISOString() };
  gigs.push(gig);
  saveGigs(gigs);
  resetForm();
  showMsg('add-msg', `âœ“ "${artist}" on ${friendlyDate(date)} added!`, 'success');
});

function resetForm() {
  document.getElementById('addForm').reset();
  delete document.getElementById('addForm').dataset.override;
}

/* ===================================================
   GIG LIST PAGE
=================================================== */
let listSortAsc = true;
let listMonthFilter = null; // null = all, or {year,month}

function renderList() {
  let gigs = loadGigs();

  // Filter by search
  const q = (document.getElementById('searchBox')?.value || '').toLowerCase();
  if (q) gigs = gigs.filter(g =>
    g.artist.toLowerCase().includes(q) || g.venue.toLowerCase().includes(q)
  );

  // Filter by month
  if (listMonthFilter) {
    const {year, month} = listMonthFilter;
    gigs = gigs.filter(g => {
      const [y,m] = g.date.split('-').map(Number);
      return y === year && m === month;
    });
    document.getElementById('listMonthLabel').textContent =
      new Date(year, month-1, 1).toLocaleDateString('en-GB',{month:'long',year:'numeric'});
  } else {
    document.getElementById('listMonthLabel').textContent = 'All dates';
  }

  // Sort
  if (!listSortAsc) gigs = [...gigs].reverse();

  const tbody = document.getElementById('gigTableBody');
  tbody.innerHTML = '';

  if (!gigs.length) {
    document.getElementById('listEmpty').style.display = '';
    document.getElementById('gigTable').style.display = 'none';
    return;
  }
  document.getElementById('listEmpty').style.display = 'none';
  document.getElementById('gigTable').style.display = '';

  gigs.forEach(g => {
    const tr = document.createElement('tr');
    const isFree = g.cost === 0;
    tr.innerHTML = `
      <td style="white-space:nowrap">${friendlyDate(g.date)}</td>
      <td><strong>${esc(g.artist)}</strong>${g.submittedBy ? `<br><small style="color:var(--muted)">by ${esc(g.submittedBy)}</small>`:''}</td>
      <td>${esc(g.venue)}</td>
      <td><span class="cost-badge${isFree?'':' paid'}">${formatCost(g.cost)}</span></td>
      <td>${g.link ? `<a class="link-out" href="${esc(g.link)}" target="_blank" rel="noopener">Tickets â†—</a>` : ''}</td>
      <td class="note-cell" title="${esc(g.notes||'')}">${esc(g.notes||'')}</td>
      <td><div class="action-btns">
        <button class="btn btn-secondary btn-sm" onclick="openEdit('${g.id}')">Edit</button>
        <button class="btn btn-danger btn-sm" onclick="deleteGig('${g.id}')">Del</button>
      </div></td>`;
    tbody.appendChild(tr);
  });
}

function toggleSort() {
  listSortAsc = !listSortAsc;
  document.getElementById('sortLabel').textContent = listSortAsc ? 'Date â†‘' : 'Date â†“';
  renderList();
}

// Month navigation for list
let listNavDate = new Date();
function prevMonth(ctx) {
  if (ctx === 'list') {
    listNavDate = new Date(listNavDate.getFullYear(), listNavDate.getMonth()-1, 1);
    listMonthFilter = {year: listNavDate.getFullYear(), month: listNavDate.getMonth()+1};
    renderList();
  } else {
    calDate = new Date(calDate.getFullYear(), calDate.getMonth()-1, 1);
    renderCalendar();
  }
}
function nextMonth(ctx) {
  if (ctx === 'list') {
    listNavDate = new Date(listNavDate.getFullYear(), listNavDate.getMonth()+1, 1);
    listMonthFilter = {year: listNavDate.getFullYear(), month: listNavDate.getMonth()+1};
    renderList();
  } else {
    calDate = new Date(calDate.getFullYear(), calDate.getMonth()+1, 1);
    renderCalendar();
  }
}
function clearMonthFilter() {
  listMonthFilter = null;
  document.getElementById('listMonthLabel').textContent = 'All dates';
  renderList();
}

/* ===================================================
   EDIT GIG
=================================================== */
function openEdit(id) {
  const g = loadGigs().find(x => x.id === id);
  if (!g) return;
  sv('e-id', id); sv('e-artist', g.artist); sv('e-date', g.date);
  sv('e-venue', g.venue); sv('e-cost', g.cost);
  sv('e-link', g.link||''); sv('e-notes', g.notes||''); sv('e-submittedBy', g.submittedBy||'');
  clearMsg('edit-msg');
  document.getElementById('editModalBg').classList.add('open');
}
function closeEditModal() { document.getElementById('editModalBg').classList.remove('open'); }

document.getElementById('editForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const id = v('e-id');
  const artist = v('e-artist').trim();
  const date   = v('e-date').trim();
  const venue  = v('e-venue').trim();
  const costRaw = v('e-cost');
  if (!artist||!date||!venue||costRaw==='') return showMsg('edit-msg','Fill all required fields.','err');
  const cost = parseFloat(costRaw);
  if (isNaN(cost)||cost<0) return showMsg('edit-msg','Cost must be â‰¥ 0.','err');

  let gigs = loadGigs();
  const idx = gigs.findIndex(g => g.id === id);
  if (idx === -1) return;
  gigs[idx] = {...gigs[idx], artist, date, venue, cost,
    link: v('e-link').trim(), notes: v('e-notes').trim(), submittedBy: v('e-submittedBy').trim()};
  saveGigs(gigs);
  closeEditModal();
  closeModal();
  if (currentPage === 'list') renderList();
  if (currentPage === 'calendar') renderCalendar();
});

/* ===================================================
   DELETE GIG
=================================================== */
function deleteGig(id, fromModal=false) {
  if (!confirm('Delete this gig?')) return;
  saveGigs(loadGigs().filter(g => g.id !== id));
  if (fromModal) closeModal();
  if (currentPage === 'list') renderList();
  if (currentPage === 'calendar') renderCalendar();
}

/* ===================================================
   CALENDAR
=================================================== */
let calDate = new Date();

function jumpToday() { calDate = new Date(); renderCalendar(); }

function renderCalendar() {
  const year = calDate.getFullYear();
  const month = calDate.getMonth(); // 0-indexed
  document.getElementById('calMonthLabel').textContent =
    new Date(year, month, 1).toLocaleDateString('en-GB',{month:'long',year:'numeric'});

  // Index gigs by date string for this month
  const gigs = loadGigs();
  const gigsByDate = {};
  gigs.forEach(g => {
    const [gy,gm] = g.date.split('-').map(Number);
    if (gy === year && gm === month+1) {
      (gigsByDate[g.date] = gigsByDate[g.date]||[]).push(g);
    }
  });

  const grid = document.getElementById('calGrid');
  grid.innerHTML = '';

  // Day headers Monâ€“Sun
  ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d => {
    const h = document.createElement('div');
    h.className = 'cal-header'; h.textContent = d; grid.appendChild(h);
  });

  // First day of month; getDay() is 0=Sun, adjust to Mon=0
  const firstDay = new Date(year, month, 1).getDay();
  const startOffset = (firstDay + 6) % 7; // cells to pad before day 1
  const daysInMonth = new Date(year, month+1, 0).getDate();
  const todayISO = toISO(new Date());

  // Pad with previous month days
  const prevDays = new Date(year, month, 0).getDate();
  for (let i = startOffset - 1; i >= 0; i--) {
    grid.appendChild(makeCalDay(prevDays - i, false, null, null));
  }

  // Current month days
  for (let d = 1; d <= daysInMonth; d++) {
    const iso = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dayGigs = gigsByDate[iso] || [];
    const cell = makeCalDay(d, true, iso, dayGigs, iso === todayISO);
    grid.appendChild(cell);
  }

  // Fill remaining cells
  const total = startOffset + daysInMonth;
  const remainder = (7 - (total % 7)) % 7;
  for (let d = 1; d <= remainder; d++) {
    grid.appendChild(makeCalDay(d, false, null, null));
  }
}

// Build a single calendar day cell
function makeCalDay(dayNum, inMonth, iso, gigs, isToday=false) {
  const cell = document.createElement('div');
  cell.className = 'cal-day' + (!inMonth?' other-month':'') + (isToday?' today':'') + (gigs&&gigs.length?' has-gigs':'');

  const numDiv = document.createElement('div');
  numDiv.className = 'cal-day-num';
  numDiv.innerHTML = `<span>${dayNum}</span>`;
  if (gigs && gigs.length) {
    numDiv.innerHTML += `<span class="badge">${gigs.length}</span>`;
  }
  cell.appendChild(numDiv);

  if (gigs) {
    gigs.forEach(g => {
      const el = document.createElement('div');
      el.className = 'cal-gig';
      el.textContent = `${g.artist} @ ${g.venue}`;
      el.setAttribute('role','button');
      el.setAttribute('tabindex','0');
      el.setAttribute('aria-label',`${g.artist} at ${g.venue}, ${formatCost(g.cost)}`);
      el.onclick = () => openModal(g.id);
      el.onkeydown = e => { if(e.key==='Enter'||e.key===' ') openModal(g.id); };
      cell.appendChild(el);
    });
  }
  return cell;
}

/* ===================================================
   DETAIL MODAL (calendar click + list)
=================================================== */
function openModal(id) {
  const g = loadGigs().find(x => x.id === id);
  if (!g) return;
  document.getElementById('modalTitle').textContent = g.artist;
  document.getElementById('modalBody').innerHTML = `
    <div class="detail-row"><span class="detail-label">Date</span><span>${friendlyDate(g.date)}</span></div>
    <div class="detail-row"><span class="detail-label">Venue</span><span>${esc(g.venue)}</span></div>
    <div class="detail-row"><span class="detail-label">Cost</span><span>${formatCost(g.cost)}</span></div>
    ${g.link?`<div class="detail-row"><span class="detail-label">Link</span><a class="link-out" href="${esc(g.link)}" target="_blank" rel="noopener">Open â†—</a></div>`:''}
    ${g.notes?`<div class="detail-row"><span class="detail-label">Notes</span><span>${esc(g.notes)}</span></div>`:''}
    ${g.submittedBy?`<div class="detail-row"><span class="detail-label">Added by</span><span>${esc(g.submittedBy)}</span></div>`:''}
  `;
  document.getElementById('modalEditBtn').onclick = () => { closeModal(); openEdit(id); };
  document.getElementById('modalDeleteBtn').onclick = () => deleteGig(id, true);
  document.getElementById('modalBg').classList.add('open');
}
function closeModal() { document.getElementById('modalBg').classList.remove('open'); }

// Close modal on backdrop click
document.getElementById('modalBg').addEventListener('click', e => { if(e.target===e.currentTarget) closeModal(); });
document.getElementById('editModalBg').addEventListener('click', e => { if(e.target===e.currentTarget) closeEditModal(); });

// Close on Escape
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeModal(); closeEditModal(); }
});

/* ===================================================
   CSV EXPORT
   Downloads current filtered/sorted list as CSV
=================================================== */
function exportCSV() {
  let gigs = loadGigs();
  const q = (document.getElementById('searchBox')?.value||'').toLowerCase();
  if (q) gigs = gigs.filter(g => g.artist.toLowerCase().includes(q)||g.venue.toLowerCase().includes(q));
  if (listMonthFilter) {
    const {year,month} = listMonthFilter;
    gigs = gigs.filter(g => { const [y,m]=g.date.split('-').map(Number); return y===year&&m===month; });
  }
  if (!listSortAsc) gigs = [...gigs].reverse();

  const headers = ['artist','date','venue','cost','link','notes','submittedBy','createdAt'];
  const rows = [headers.join(',')];
  gigs.forEach(g => {
    rows.push(headers.map(h => csvCell(g[h]??'')).join(','));
  });
  download('newcastle_gigs.csv', rows.join('\r\n'), 'text/csv');
}

// Wrap value in quotes if it contains comma/quote/newline
function csvCell(val) {
  const s = String(val);
  return /[,"\n\r]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
}

function download(filename, text, mime) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text],{type:mime}));
  a.download = filename; a.click();
}

/* ===================================================
   CSV IMPORT
   Accepts case-insensitive headers; merges by artist+date+venue dedup
=================================================== */
function importCSV(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const text = e.target.result;
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    if (!lines.length) return showMsg('import-msg','Empty file.','err');

    // Parse header row (normalise to lowercase)
    const headers = parseCSVRow(lines[0]).map(h => h.trim().toLowerCase());
    const get = (row, key) => {
      const i = headers.indexOf(key);
      return i >= 0 ? (row[i]||'').trim() : '';
    };

    let added=0, skipped=0;
    const existing = loadGigs();
    const newGigs = [...existing];

    for (let i = 1; i < lines.length; i++) {
      const row = parseCSVRow(lines[i]);
      const artist = get(row,'artist');
      const date   = get(row,'date');
      const venue  = get(row,'venue');
      const costRaw= get(row,'cost');
      if (!artist||!date||!venue) { skipped++; continue; }
      if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) { skipped++; continue; }
      const cost = parseFloat(costRaw);
      if (isNaN(cost)||cost<0) { skipped++; continue; }

      // Deduplicate
      const dup = newGigs.find(g =>
        g.artist.toLowerCase()===artist.toLowerCase()&&
        g.date===date&&g.venue.toLowerCase()===venue.toLowerCase()
      );
      if (dup) { skipped++; continue; }

      newGigs.push({ id: uid(), artist, date, venue, cost,
        link: get(row,'link'), notes: get(row,'notes'),
        submittedBy: get(row,'submittedby')||get(row,'submitted_by'),
        createdAt: new Date().toISOString() });
      added++;
    }

    saveGigs(newGigs);
    showMsg('import-msg',`Import complete: ${added} added, ${skipped} skipped.`, added>0?'success':'warn');
    renderList();
  };
  reader.readAsText(file);
  input.value=''; // reset so same file can be re-imported
}

// Minimal CSV row parser supporting quoted fields
function parseCSVRow(line) {
  const cells = []; let cur=''; let inQ=false;
  for (let i=0;i<line.length;i++) {
    const c=line[i];
    if (c==='"') { if(inQ&&line[i+1]==='"'){cur+='"';i++;}else inQ=!inQ; }
    else if (c===','&&!inQ){cells.push(cur);cur='';}
    else cur+=c;
  }
  cells.push(cur);
  return cells;
}

/* ===================================================
   UTILITY HELPERS
=================================================== */
// Get input value by id
const v = id => document.getElementById(id)?.value ?? '';
// Set input value by id
const sv = (id,val) => { const el=document.getElementById(id); if(el) el.value=val??''; };
// Escape HTML to prevent XSS
const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
// Convert Date to yyyy-mm-dd local
function toISO(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

// Show a message in a container div
function showMsg(id, text, type) {
  const el = document.getElementById(id);
  if (!el) return;
  el.innerHTML = `<div class="alert alert-${type}">${text}</div>`;
  if (type==='success') setTimeout(()=>{if(el) el.innerHTML='';},4000);
}
function clearMsg(id) { const el=document.getElementById(id); if(el) el.innerHTML=''; }

/* ===================================================
   INIT â€“ hydrate on load
=================================================== */
// Ensure storage is readable on first load
loadGigs();
// Pre-set list month nav to current month
listNavDate = new Date();
renderList();
</script>

</body>
</html>